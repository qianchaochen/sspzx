package com.gionee.ssp.service.ipush.es.impl;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;

import org.apache.commons.lang3.RandomUtils;
import org.springframework.stereotype.Service;
import org.springframework.util.ObjectUtils;

import com.gionee.ssp.service.ipush.es.ResultService;
import com.wk.ssp.mvc.ipush.es.vo.CampaignVO;
import com.wk.ssp.mvc.ipush.es.vo.CreativeVO;
import com.wk.ssp.mvc.ipush.es.vo.QueryVO;

/**
 *
 * 结果集服务实现类
 *
 */
@Service
public class ResultServiceImpl implements ResultService {

    /**
     * 通过排序得到最佳结果
     * 
     * @param campaignVOList 传入的结果集
     * @param queryVO 查询条件
     * @return 返回最佳结果
     */
    @Override
    public List<CampaignVO> getTheBestResultViaRanking(final List<CampaignVO> campaignVOList, final QueryVO queryVO) {
        List<CampaignVO> campaignVOs = null;

        if (ObjectUtils.isEmpty(campaignVOList)) {
            return campaignVOs;
        }

        campaignVOs = this.randomCampaignVO(campaignVOList, queryVO.getCount());

        // 活动列表的大小
        int campaignSize = campaignVOs.size();
        for (int i = 0; i < campaignSize; i++) {
            CampaignVO campaignVO = campaignVOs.get(i);
            CreativeVO creativeVO = this.randomCreativeVO(campaignVO, queryVO);
            campaignVO.setCreatives(new CreativeVO[] { creativeVO });
        }
        return campaignVOs;
    }

    /*****************************************************************************************
     * 私有方法
     *****************************************************************************************/

    /**
     * 从最优的活动竞价中随机抽取一个创意
     * 
     * @param creativeVOs 创意列表
     * @return 返回一个创意
     */
    private CreativeVO randomCreativeVO(final CampaignVO campaignVO, final QueryVO queryVO) {
//        List<CreativeVO> creativeVOList = new ArrayList<CreativeVO>();
        CreativeVO[] creativeVOs = campaignVO.getCreatives();
//        for (CreativeVO creativeVO : creativeVOs) {
//            if (campaignVO.getItem_type() == 5) { // 图文类的广告直接加入到list
//                creativeVOList.add(creativeVO);
//            } else if (campaignVO.getItem_type() == 4) { // 如果不是图文广告，需要拿创意的尺寸和请求的尺寸进行匹配
//                List<CreativeMessageVO> creativeMessageVOs = queryVO.getCreativeMessageVO();
//                for (CreativeMessageVO creativeMessageVO : creativeMessageVOs) {
//                    if (creativeVO.getW() == creativeMessageVO.getW()
//                            && creativeVO.getH() == creativeMessageVO.getH()) { // 匹配尺寸
//                        creativeVOList.add(creativeVO);
//                    }
//                }
//            } else {// 纯图片广告需要拿创意的尺寸、标题长度和请求的尺寸、标题长度进行匹配
//                List<CreativeMessageVO> creativeMessageVOs = queryVO.getCreativeMessageVO();
//                for (CreativeMessageVO creativeMessageVO : creativeMessageVOs) {
//                    if (creativeVO.getW() == creativeMessageVO.getW() && creativeVO.getH() == creativeMessageVO.getH()
//                            && creativeVO.getTitle_len() <= creativeMessageVO.getLen()
//                            && creativeVO.getSub_title_len() <= creativeMessageVO.getSub_len()) { // 匹配尺寸、标题长度
//                        creativeVOList.add(creativeVO);
//                    }
//                }
//            }
//        }
        
        if(creativeVOs.length == 0){
        	return null;
        }
        // 随机选取一个符合规格的广告进行显示
        int num = RandomUtils.nextInt(0, creativeVOs.length);
        return creativeVOs[num];
    }

    /**
     * 从多个活动中随机抽取一个活动
     * 
     * @param campaignVOList 活动列表列表
     * @param count 广告条数
     * @return 返回一个创意
     */
    private List<CampaignVO> randomCampaignVO(List<CampaignVO> campaignVOList, int count) {

        List<CampaignVO> campaignVOs = new ArrayList<CampaignVO>();
        List<CampaignVO> copyCampaignVOList = new ArrayList<CampaignVO>(campaignVOList);
        //CPT > CPM > CPC, 根据直投模式优先级去拿直投广告
        //打乱顺序, 获得初始的随机性
        Collections.shuffle(copyCampaignVOList);
        
        //根据mode进行排序, 分别将所有活动以cpt,cpm,cpc的顺序进行排序
        Collections.sort(copyCampaignVOList, modeComparator);
        
        for (int i = 0; i < count; i++) {
            if (ObjectUtils.isEmpty(copyCampaignVOList)) {
                break;
            }
            CampaignVO campaignVO = copyCampaignVOList.get(i);
            campaignVOs.add(campaignVO);
            copyCampaignVOList.remove(campaignVO);
        }

        return campaignVOs;
    }
    
    
    /**
	 * ecpm竞价比较器
	 */
	private final Comparator<CampaignVO> modeComparator = new Comparator<CampaignVO>() {
		@Override
		public int compare(CampaignVO one, CampaignVO two) {
			if (one.getMode() - two.getMode() > 0) {
				return 1;
			} else if (one.getMode() - two.getMode() < 0) {
				return -1;
			} else {
				return 0;
			}
		}
	};
}
